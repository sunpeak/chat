<html xmlns:th="http://www.thymeleaf.org">
<meta charset="UTF-8"/>
<head>
    <title>Chat</title>
    <link th:href="@{//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css}" rel="stylesheet"/>
    <script th:src="@{//cdn.bootcss.com/sockjs-client/1.1.4/sockjs.min.js}"></script>
    <script th:src="@{//cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js}"></script>
    <script th:src="@{//cdn.bootcss.com/jquery/3.2.1/jquery.min.js}"></script>
    <script th:src="@{//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js}"></script>

    <style>
        .main-panel {
            margin-top: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row ">
        <div class="col-md-4" style="padding: 5px">
            <div class="main-panel panel panel-default">
                <div class="panel-heading ">
                    <div class="row ">
                        <div class="col-md-offset-3 col-md-6 text-center">
                            Friend
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-link pull-right" style="border:0px;padding:0px"
                                    id="logout">
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="row " id="friends">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4" style="padding: 5px">
            <div class="main-panel panel panel-default">
                <div class="panel-heading text-center">
                    Chat
                </div>
                <div class="panel-body">
                    <div class="form-group  col-md-12">
                            <textarea rows="5" style="width: 100%;" th:id="text"
                                      placeholder="input text ..."></textarea>
                    </div>
                    <div class="form-group  col-md-12">
                        <button type="button" id="submit" class="btn btn-md btn-default btn-block ">Send</button>

                    </div>
                </div>
            </div>

        </div>
        <div class="col-md-4" style="padding: 5px">
            <div class="main-panel  panel panel-default">
                <div class="panel-heading text-center">
                    Message
                </div>
                <div id="output" class="panel-body">
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    var sock = new SockJS("/endpointChat");
    var stomp = Stomp.over(sock);
    stomp.connect('guest', 'guest', function (frame) {
        stomp.subscribe("/user/queue/message", handleMessage);
    });

    function handleMessage(message) {
        $('#output').prepend(message.body);
    }

    $('#submit').click(function (e) {
        var text = $('#text').val();
        if (!text) {
            alert("please input text")
            return
        }
        sendSpittle(text);
    });

    $('#logout').click(function (e) {
        $.ajax({
            url: "/logout",
            type: "POST",
            success: function (data) {
                window.location.href = "/login";
            }
        });
    });

    function sendSpittle(text) {
        var user_array = new Array();
        $.each($('input:checkbox:checked'), function () {
            user_array.push($(this).val());
        });

        if (user_array.length == 0) {
            alert("please select friend")
            return;
        }

        $.each($('input:checkbox:checked'), function () {
            stomp.send("/chat." + $(this).val(), {}, text);
            $(this).prop("checked", false);
        });
    }

    function flushusers() {
        $.ajax({
            url: "/users",
            type: "GET",
            success: function (data) {
                $("#friends").empty();
                if (data) {
                    var html = "";
                    data.split(",").forEach(function (user) {
                        html += /*<![CDATA[*/
                                "<label class=\"checkbox\">"
                                + "  <div class=\"col-md-6 text-right \">"
                                + "  <input type=\"checkbox\" value=\"" + user + "\"/></div>" + user + "<div class=\"col-md-6\"> "
                                + "</div></label>";
                        /*]]>*/
                    })
                    $("#friends").append(html);
                }
            }
        });
    }

    setInterval("flushusers()", 10000);

</script>


</body>
</html>